name: Create Java Reactive Service (Cookiecutter)

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "Repo (kebab-case). Ej: customer-api"
        required: true
      service_name:
        description: "Service name (kebab-case). Ej: customer-api"
        required: true
      group_id:
        description: "GroupId. Ej: com.demo"
        required: true
        default: "com.demo"
      base_package:
        description: "Base package. Ej: com.demo.customer"
        required: true
        default: "com.demo.customer"
      visibility:
        description: "private/public"
        required: true
        default: "private"

jobs:
  scaffold:
    runs-on: ubuntu-latest
    steps:
      - name: Install cookiecutter
        run: |
          python -m pip install --upgrade pip
          pip install cookiecutter

      - name: Generate project from existing template repo
        run: |
          cookiecutter https://github.com/platform-engi/tpl-spring-reactive-openapi.git \
            --no-input \
            repo_name="${{ inputs.repo_name }}" \
            service_name="${{ inputs.service_name }}" \
            group_id="${{ inputs.group_id }}" \
            base_package="${{ inputs.base_package }}"

      - name: Create repo
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
        run: |
          REPO="${{ inputs.repo_name }}"
          VIS="${{ inputs.visibility }}"
          gh repo create platform-engi/${REPO} --${VIS} --confirm

      - name: Push generated content
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
        run: |
          REPO="${{ inputs.repo_name }}"
          cd "${REPO}"
          git init
          git config user.name "platform-bot"
          git config user.email "platform-bot@users.noreply.github.com"
          git add .
          git commit -m "chore: bootstrap ${REPO}"
          git branch -M main
          git remote add origin "https://github.com/platform-engi/${REPO}.git"
          git push -u origin main
